<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片压缩</title>
    <script type="text/javascript" src="lib/browser-image-compression.js"></script>
</head>

<body style="margin: 0; padding: 0;">
    <h1 style="text-align: center;">图片压缩</h1>
    <p style="text-align: center; color: red;">没有保存，就没有泄露，本站不会保存您的任何图片资源</p>
    <p style="text-align: center; color: red;">打开该网页后，您可以断网（拔网线或开飞行模式）进行图片压缩工作</p>
    <div style="border-top: orange 1px solid; border-bottom: orange 1px solid; height: 300px;">
        <div style="height: 100%;display: flex;flex-direction: column;justify-content: center;">
            <div style="display: flex;">
                <div style="min-width: 500px;">
                    <div style="display: flex;justify-content: center;">
                        <img id="srcImage" src="" alt="" srcset="" style="max-height: 260px;">
                    </div>
                </div>
                <div style="flex: 1;">
                    <div style="height: 100%;display: flex;flex-direction: column;justify-content: center;">
                        <input type="file" accept="image/*" onchange="handleImageUpload(event);">
                        <div>大小：<span id="srcImageSize"></span></div>
                        <div>像素：<span id="srcImagePixel"></span></div>
                        <div>期望压缩后图片最大大小：<input id="expectCompressedImageSize" value="1" />MB</div>
                        <div>期望压缩后图片最大像素：<input id="expectCompressedImagePixel" value="1920" /></div>
                        <button id="reCompressed" onclick="reHandleImage()" style="width: 70px;display: none;">重新压缩</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div style="border-bottom: orange 1px solid; height: 300px;">
        <div style="height: 100%;display: flex;flex-direction: column;justify-content: center;">
            <div style="display: flex;">
                <div style="min-width: 500px;">
                    <div style="display: flex;justify-content: center;">
                        <img id="destImage" src="" alt="" srcset="" style="max-height: 260px;">
                    </div>
                </div>
                <div style="flex: 1;">
                    <div style="height: 100%;display: flex;flex-direction: column;justify-content: center;">
                        <button id="download" onclick="download()" style="width: 70px;display: none;">下载</button>
                        <div>大小：<span id="destImageSize"></span></div>
                        <div>像素：<span id="destImagePixel"></span></span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function handleImageUpload(event) {
            var imageFile = event.target.files[0];
            var imageUrl = URL.createObjectURL(imageFile)
            document.getElementById("srcImage").src = imageUrl
            handleImage(imageUrl, imageFile);
        }

        function reHandleImage() {
            var imageUrl = document.getElementById("srcImage").src
            var xhr = new XMLHttpRequest();
            xhr.open("get", imageUrl, true);
            xhr.responseType = "blob";
            xhr.onload = function () {
                if (this.status == 200) {
                    handleImage(imageUrl, this.response);
                }
            };
            xhr.send();
        }

        function handleImage(imageUrl, imageFile) {
            var downloadButton = document.getElementById("download");
            downloadButton.style.display = "none"
            var reCompressedButton = document.getElementById("reCompressed");
            reCompressedButton.style.display = "none"

            var img = new Image();
            img.src = imageUrl;
            img.onload = function () {
                document.getElementById("srcImagePixel").innerText = this.width + '×' + this.height
            };

            document.getElementById("srcImageSize").innerText = imageFile.size < 1024 ? imageFile.size + "B" : imageFile.size / 1024 < 1024 ? (imageFile.size / 1024).toFixed(2) + "KB" : (imageFile.size / 1024 / 1024).toFixed(2) + "MB"

            console.log(`originalFile size ${imageFile.size} B`);

            var expectCompressedImageSize = parseFloat(document.getElementById("expectCompressedImageSize").value);
            var expectCompressedImagePixel = parseInt(document.getElementById("expectCompressedImagePixel").value);

            var options = {
                maxSizeMB: expectCompressedImageSize,
                maxWidthOrHeight: expectCompressedImagePixel,
                useWebWorker: true
            }
            imageCompression(imageFile, options)
                .then(function (compressedFile) {
                    console.log(`compressedFile size ${imageFile.size} B`); // smaller than maxSizeMB

                    const destImageUrl = URL.createObjectURL(compressedFile);
                    document.getElementById("destImage").src = destImageUrl
                    downloadButton.style.display = "block"
                    reCompressedButton.style.display = "block"

                    var img = new Image();
                    img.src = destImageUrl;
                    img.onload = function () {
                        document.getElementById("destImagePixel").innerText = this.width + '×' + this.height
                    };

                    document.getElementById("destImageSize").innerText = compressedFile.size < 1024 ? compressedFile.size + "B" : compressedFile.size / 1024 < 1024 ? (compressedFile.size / 1024).toFixed(2) + "KB" : (compressedFile.size / 1024 / 1024).toFixed(2) + "MB"
                })
                .catch(function (error) {
                    console.log(error.message);
                });
        }

        function download() {
            let link = document.createElement('a');
            link.download = `image_${new Date().getTime()}.png`;
            link.href = document.getElementById("destImage").src;
            link.click();
        }
    </script>
</body>

</html>